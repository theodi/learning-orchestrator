<%- include('../../partials/header') %>

<section class="content-block light-grey">
  <h1>Course Enrollment</h1>
  <strong>DO NOT USE THIS FORM FOR NEW PAID SELF PACED COURSES.</strong>
  <p>Enroll users in Moodle courses. Users with existing Moodle accounts will be enrolled immediately. New users will receive instructions to create accounts.</p>

  <form id="enrollmentForm" class="mt-4">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="courseSelect">Course *</label>
          <select id="courseSelect" name="courseId" class="form-control" required>
            <option value="">Select a course...</option>
            <% courses.forEach(function(course) { %>
              <option value="<%= course.id %>" data-name="<%= course.fullname %>">
                <%= course.fullname %> (<%= course.shortname %>)
              </option>
            <% }); %>
          </select>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="form-group">
          <label for="durationSelect">Enrollment Duration *</label>
          <select id="durationSelect" name="durationMonths" class="form-control" required>
            <option value="">Select duration...</option>
            <option value="3">3 months</option>
            <option value="6">6 months</option>
            <option value="12">12 months</option>
            <option value="24">24 months</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="userEmails">User Email Addresses *</label>
      <textarea id="userEmails" name="userEmails" class="form-control" rows="6" 
                placeholder="Enter email addresses, one per line or separated by commas&#10;example@company.com&#10;another@company.com&#10;third@company.com" required></textarea>
      <small class="form-text text-muted">You can enter multiple email addresses separated by commas or on separate lines.</small>
    </div>

    <div class="form-group">
      <button type="submit" class="btn btn-primary" id="submitBtn">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        Process Enrollments
      </button>
    </div>
  </form>

  <!-- Results Section -->
  <div id="resultsSection" class="mt-4" style="display: none;">
    <h3>Enrollment Results</h3>
    
    <div id="successResults" class="alert alert-success" style="display: none;">
      <h4>Successfully Enrolled</h4>
      <ul id="successList"></ul>
    </div>
    
    <div id="pendingResults" class="alert alert-warning" style="display: none;">
      <h4>Pending Account Creation</h4>
      <p>These users will receive emails with instructions to create ODI accounts and access Moodle.</p>
      <ul id="pendingList"></ul>
    </div>
    
    <div id="failedResults" class="alert alert-danger" style="display: none;">
      <h4>Failed Enrollments</h4>
      <ul id="failedList"></ul>
    </div>
  </div>
</section>

<script>
$(document).ready(function() {
  $('#enrollmentForm').on('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = $('#submitBtn');
    const spinner = submitBtn.find('.spinner-border');
    const originalText = submitBtn.text().trim();
    
    // Show loading state
    submitBtn.prop('disabled', true);
    spinner.removeClass('d-none');
    submitBtn.text('Processing...');
    
    // Get form data
    const courseId = $('#courseSelect').val();
    const courseName = $('#courseSelect option:selected').data('name');
    const durationMonths = $('#durationSelect').val();
    const userEmails = $('#userEmails').val();
    
    // Process enrollment
    fetch('/enrollments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        courseId: courseId,
        courseName: courseName,
        durationMonths: parseInt(durationMonths),
        userEmails: userEmails
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayResults(data.data);
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing enrollments.');
    })
    .finally(() => {
      // Reset button state
      submitBtn.prop('disabled', false);
      spinner.addClass('d-none');
      submitBtn.text(originalText);
    });
  });
  
  function displayResults(results) {
    // Clear previous results
    $('#successList, #pendingList, #failedList').empty();
    
    // Display successful enrollments
    if (results.successful && results.successful.length > 0) {
      results.successful.forEach(item => {
        $('#successList').append(`<li>${item.email} - Enrolled successfully</li>`);
      });
      $('#successResults').show();
    } else {
      $('#successResults').hide();
    }
    
    // Display pending enrollments
    if (results.pending && results.pending.length > 0) {
      results.pending.forEach(item => {
        $('#pendingList').append(`<li>${item.email} - Pending account creation</li>`);
      });
      $('#pendingResults').show();
    } else {
      $('#pendingResults').hide();
    }
    
    // Display failed enrollments
    if (results.failed && results.failed.length > 0) {
      results.failed.forEach(item => {
        $('#failedList').append(`<li>${item.email} - ${item.reason}</li>`);
      });
      $('#failedResults').show();
    } else {
      $('#failedResults').hide();
    }
    
    // Show results section
    $('#resultsSection').show();
    
    // Scroll to results
    $('#resultsSection')[0].scrollIntoView({ behavior: 'smooth' });
  }
});
</script>

<%- include('../../partials/footer') %>
