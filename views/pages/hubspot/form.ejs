<%- include('../../partials/headerForm') %>
<section class="content-block light-grey">

  <div class="container">
    <div class="jumbotron">
      <h1 class="text-primary text-center"><span class="fa fa-user"></span> ODI Learning Course - Client Bookings</h1>
      <br/>
      <!-- Pills tab menu -->
      <nav>
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
        <button class="nav-link active" style="margin:1px;" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Online</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" style="margin:1px;" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Self-paced</button>
        </li>
      </ul>
      </nav>
      
      <div class="tab-content" id="pills-tabContent">
          <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
            <form action="/hubspot/form" method="POST" id="hubspotForm" name="ODI Learning - Client Bookings">
                
               
                  <label for="subClientSelect" class="col-sm-3 col-form-label">Sub-client Name:</label><br/>
                  <div style="background-color: #fff; width:50%;padding-top: 1%;">
                    <select id="subClientSelect" name="sub_client" class="" required style="background-color:white;width:100%;">
                      <option value="">-- Select --</option>
                    </select>
                  </div>
                  <br/>
                   <!-- Course location -->
                      <label class="" style="min-width: 200px;">Course Location:</label>
                      <div class="">
                          <input type="radio" class="" name="course_location" value="Online" required>
                          <label class="">Online</label>
                      </div>
                      <div class="">
                          <input type="radio" class="" name="course_location" value="In person" required>
                          <label class="">In Person</label>
                      </div>
                      <br/>
                      <!-- Course Name -->
                  
                  <label class="" style="min-width: 200px;">Course Name:</label>
                  <select name="course_name" class="" required>
                    <option value="">-- Select --</option>
                    <% products.forEach(product => { %>
                      <option value="<%= product.name %>"><%= product.name %></option>
                    <% }) %>
                  </select>
                  <br/>
                 
                  

                      <!-- Date and Time -->
                      <label class="mb-0 mr-2" style="min-width: 200px;">Course Date and Time:</label>
                      <input type="datetime-local" name="course_datetime" class="" required>
                      <br/>
                   
                      <!-- Duration -->
                      <label class="" style="">Course Duration (hours):</label>
                      <input type="number" name="course_duration" class="" required>
                <br/>
  
                  <!-- Tutor Name -->
                <label class="" style="min-width: 200px;">Tutor Name:</label>
                <select name="tutor_name" id="tutorName" class="" required>
                  <option value="">-- Select --</option>
                <% tutors.forEach(tutor => { %>
                   <option value="<%= tutor.first_name %> <%= tutor.last_name %>"><%= tutor.first_name %> <%= tutor.last_name %></option>
                <% }) %>
                </select>
                <br/>

                  <!-- Tutor Email (auto-filled) -->
                <label class="" style="min-width: 200px;">Tutor Email:</label>
                  <input type="email" name="tutor_email" id="tutorEmail" class="" readonly required>
                  <br/>

                      <!-- Booking Reference -->
                  <div class="">
                      <label class="" style="min-width: 200px;">Booking Reference Number:</label>
                      <input type="text" name="booking_ref" class="" required>
                    </div>
                  
                <br/>
                  <!-- Client Requestor Name -->
                      <label class="" style="">Client Requestor Name:</label>
                      <div style="background-color: white; width:32%;padding-top: 1%;">
                        <select id="clientRequestorEmail" name="client_requestor" class="" required style="background-color:white;width:100%;">
                        <!--<option value="">-- Select --</option>-->
                        </select>
                      </div>
                  
                    <br/>
                    <!-- Client Requestor Email -->
                    <div class="">
                      <label class="" style="">Client Email (selected):</label>
                      <input type="email" id="clientRequestorEmailDisplay" name="client_requestor_email" class="" readonly required>
                    </div>
                 <br/>

                      <!-- Value -->
                  <div class="">
                      <label class="" style="min-width: 200px;">Value(£):</label>
                      <input type="number" name="value" class="" required>
                    </div>
                  
                <br/>
                      <!-- Completed By Name -->
                   <div class="">
                      <label class="" style="min-width: 200px;">Form Completed By Name:</label>
                      <input type="text" name="completed_by_name" class="" value="<%= userName%>" required readonly>
                    </div>
                  
                    <!-- Completed By Email -->
                    <div class="">
                      <label class="" style="min-width: 200px;">Form Completed By Email:</label>
                      <input type="email" name="completed_by_email" class="" value="<%= userEmail %>" required readonly>
                    </div>
                  
                  
                <br/>
                <input type="hidden" name="submission_timestamp" id="submissionTimestamp">

                  <div class="">
                    <button type="submit" class="">Submit</button>
                  </div>

            </form>
          </div>
      </div>
          <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
            <!-- Sel-paced -->

            <form action="/hubspot/self_paced" method="POST" id="hubspotForm" name="ODI Learning - Client Bookings">

              <!-- Course Name -->
                  
                  <label class="" style="min-width: 200px;">Course Name:</label>
                  <select name="course_name_sp" class="" required>
                    <option value="">-- Select --</option>
                    <% products.forEach(product => { %>
                      <option value="<%= product.name %>"><%= product.name %></option>
                    <% }) %>
                  </select>
                  <br/>
                  <!-- Client Requestor Name -->
                      <label class="" style="">Client Requestor Name:</label>
                      <div style="background-color: white; width:32%;padding-top: 1%;">
                        <select id="clientRequestorEmail2" name="client_requestor_sp" class="" required style="background-color:white;width:100%;">
                        <!--<option value="">-- Select --</option>-->
                        </select>
                      </div>
                  
                    <br/>
                    <!-- Client Requestor Email -->
                    <div class="">
                      <label class="" style="">Client Email (selected):</label>
                      <input type="email" id="clientRequestorEmailDisplay2" name="client_requestor_email_sp" class="" readonly required>
                    </div>
                 <br/>

              <input type="hidden" name="self_paced" id="self_paced" value="self paced">
              <!--<input type="hidden" name="submission_selfpaced" id="submission_selfpaced" value="">-->
              <div class="">
                    <button type="submit" class="">Submit</button>
                  </div>
              

            </form>
            
          </div>
      </div>

      <!-- End of pills tab menu -->
      
    </div>


</section>

<script>
  // Tutor email map
  const tutorEmails = {
    <% tutors.forEach((tutor, index) => { %>
      "<%= tutor.first_name %> <%= tutor.last_name %>": "<%= tutor.email %>"<%= index < tutors.length - 1 ? ',' : '' %>
    <% }) %>
  };

  // Auto-fill tutor email
  document.getElementById('tutorName').addEventListener('change', function () {
    document.getElementById('tutorEmail').value = tutorEmails[this.value] || '';
  });
</script>

<script>
  let nextAfter = null;
  const select = document.getElementById('subClientSelect');

  async function loadCompanies(after = null) {
    const res = await fetch(`/hubspot/companies${after ? `?after=${after}` : ''}`);
    const { companies, nextAfter: next } = await res.json();

    companies.forEach(company => {
      const option = document.createElement('option');
      option.value = company.id;
      option.textContent = company.name;
      select.appendChild(option);
    });

    nextAfter = next;

    // Add or update Load More option
    const existing = document.getElementById('loadMoreOption');
    if (nextAfter) {
      if (!existing) {
        const more = document.createElement('option');
        more.id = 'loadMoreOption';
        more.disabled = true;
        more.textContent = '⏳ Scroll to load more...';
        select.appendChild(more);
      }
    } else if (existing) {
      existing.remove(); // No more to load
    }
  }

  // Load first batch on page load
  loadCompanies();

  // Load more on scroll to bottom
  select.addEventListener('scroll', function () {
    const { scrollTop, scrollHeight, clientHeight } = select;
    if (scrollTop + clientHeight >= scrollHeight - 5 && nextAfter) {
      loadCompanies(nextAfter);
    }
  });
</script>

<script>
  $('#subClientSelect').select2({
    theme: 'bootstrap4',
    placeholder: 'Click to search company...',
    minimumInputLength: 2,
    ajax: {
      url: '/hubspot/companies/search',
      delay: 300,
      data: function (params) {
        return {
          q: params.term // search term
        };
      },
      processResults: function (data) {
        return {
          results: data.map(company => ({
            id: company.id,
            text: company.name
          }))
        };
      }
    }
  });
</script>

<script>
  $(document).ready(function () {
    $('#clientRequestorEmail').select2({
      theme: 'bootstrap4',
      placeholder: 'Search for a client...',
      tags: true,
      minimumInputLength: 2,
      ajax: {
        url: '/hubspot/contacts/search',
        delay: 300,
        data: function (params) {
          return { q: params.term };
        },
        processResults: function (data) {
          return {
            results: data.map(contact => ({
              id: contact.email, // submitted value
              text: `${contact.first_name} ${contact.last_name}`
            }))
          };
        }
      },
      //width: '100%'
    });

    // Show selected email in display input
    $('#clientRequestorEmail').on('select2:select', function (e) {
      const selectedEmail = e.params.data.id;
      document.getElementById('clientRequestorEmailDisplay').value = selectedEmail;
    });
  });
</script>

<script>
  // Auto-fill client requestor email
  document.addEventListener('DOMContentLoaded', function () {
    const select = document.getElementById('clientRequestorEmail');
    const display = document.getElementById('clientRequestorEmailDisplay');

    if (select && display) {
      $(select).on('select2:select', function (e) {
        const value = e.params.data.id;

        // Check for email pattern in "(email)"
        const emailMatch = value.match(/\(([^)]+)\)$/);

        if (emailMatch) {
          display.value = emailMatch[1];
          display.readOnly = true;
        } else {
          display.value = '';
          display.readOnly = false;
        }
      });

      // Handle manual user input (custom tag)
      $(select).on('change', function (e) {
        const selectedText = $(this).val();

        // If no parentheses pattern, assume manual entry
        if (!selectedText.includes('(')) {
          display.value = '';
          display.readOnly = false;
        }
      });
    }
  });
</script>

<!-- Self Paced Form -->
 <script>
  $(document).ready(function () {
    $('#clientRequestorEmail2').select2({
      theme: 'bootstrap4',
      placeholder: 'Search for a client...',
      tags: true,
      minimumInputLength: 2,
      ajax: {
        url: '/hubspot/contacts/search',
        delay: 300,
        data: function (params) {
          return { q: params.term };
        },
        processResults: function (data) {
          return {
            results: data.map(contact => ({
              id: contact.email, // submitted value
              text: `${contact.first_name} ${contact.last_name}`
            }))
          };
        }
      },
      //width: '100%'
    });

    // Show selected email in display input
    $('#clientRequestorEmail2').on('select2:select', function (e) {
      const selectedEmail = e.params.data.id;
      document.getElementById('clientRequestorEmailDisplay2').value = selectedEmail;
    });
  });
</script>

<script>
  // Auto-fill client requestor email
  document.addEventListener('DOMContentLoaded', function () {
    const select = document.getElementById('clientRequestorEmail2');
    const display = document.getElementById('clientRequestorEmailDisplay2');

    if (select && display) {
      $(select).on('select2:select', function (e) {
        const value = e.params.data.id;

        // Check for email pattern in "(email)"
        const emailMatch = value.match(/\(([^)]+)\)$/);

        if (emailMatch) {
          display.value = emailMatch[1];
          display.readOnly = true;
        } else {
          display.value = '';
          display.readOnly = false;
        }
      });

      // Handle manual user input (custom tag)
      $(select).on('change', function (e) {
        const selectedText = $(this).val();

        // If no parentheses pattern, assume manual entry
        if (!selectedText.includes('(')) {
          display.value = '';
          display.readOnly = false;
        }
      });
    }
  });
</script>

<script>
  // Set submission date/time in ISO format (e.g., 2024-03-27T15:42:00Z)
  document.getElementById('submissionTimestamp').value = new Date().toISOString();
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>






<%- include('../../partials/footer') %>
