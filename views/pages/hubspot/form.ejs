<%- include('../../partials/header') %>
<section class="content-block light-grey">

  <div class="container">
    <div class="jumbotron">
      <h1 class="text-primary text-center"><span class="fa fa-user"></span> ODI Learning Course - Client Bookings</h1>
      
      <div class="row justify-content-center">
        <div class="">
              <form action="/hubspot/form" method="POST" id="hubspotForm" name="ODI Learning - Client Bookings">

  
                <div class="form-group row">
                  <div class="form-group d-flex align-items-center"> 
                  <label for="subClientSelect" class="col-sm-3 col-form-label">Sub-client Name:</label><br/>
                  <div style="background-color: #fff; width:50%;padding-top: 1%;">
                    <select id="subClientSelect" name="sub_client" class="form-control" required style="background-color:white;width:100%;">
                      <option value="">-- Select --</option>
                    </select>
                  </div>
                   
                 
                  </div>
                </div>

                  <br/>
                
                  <div class="form-group row" >
  
                   <!-- Course location -->
                  <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Course Location:</label>
                      <div class="d-flex align-items-center">
                      <div class="form-check mr-3">
                          <input type="radio" class="form-check-input" name="course_location" value="Online" required>
                          <label class="form-check-label">Online</label>
                      </div>
                      <div class="form-check">
                          <input type="radio" class="form-check-input" name="course_location" value="In person" required>
                          <label class="form-check-label">In Person</label>
                      </div>
                  </div>
                  </div>
                  <br/>
                      <!-- Course Name -->
                  <div class="form-group d-flex align-items-center">
                  <label class="mb-0 mr-2" style="min-width: 200px;">Course Name:</label>
                  <select name="course_name" class="form-control" required>
                    <option value="">-- Select --</option>
                    <% products.forEach(product => { %>
                      <option value="<%= product.name %>"><%= product.name %></option>
                    <% }) %>
                  </select>
                  </div>
                  <br/>
                  <div class="form-group row">

                    <div class="col">

                      <!-- Date and Time -->
                    <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Course Date and Time:</label>
                      <input type="datetime-local" name="course_datetime" class="form-control" required>
                    </div>

                    </div>

                    <div class="col">
                      <!-- Duration -->
                    <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Course Duration (hours):</label>
                      <input type="number" name="course_duration" class="form-control" required>
                    </div>
                    </div>

                  </div>
                    
                  </div>
                  
                <br/>
                  <div class="form-group row" >
                  <!-- Tutor Name -->
                <div class="form-group d-flex align-items-center">
                <label class="mb-0 mr-2" style="min-width: 200px;">Tutor Name:</label>
                <select name="tutor_name" id="tutorName" class="form-control col-form-label-lg " required>
                  <option value="">-- Select --</option>
                <% tutors.forEach(tutor => { %>
                   <option value="<%= tutor.first_name %> <%= tutor.last_name %>"><%= tutor.first_name %> <%= tutor.last_name %></option>
                <% }) %>
                </select>
                </div>

                  <!-- Tutor Email (auto-filled) -->
                <div class="form-group d-flex align-items-center">
                <label class="mb-0 mr-2" style="min-width: 200px;">Tutor Email:</label>
                  <input type="email" name="tutor_email" id="tutorEmail" class="form-control" readonly required>
                </div>

                  </div>
                  <br/>
                  <div class="form-group row" >
                      <!-- Booking Reference -->
                  <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Booking Reference Number:</label>
                      <input type="text" name="booking_ref" class="form-control" required>
                    </div>
                  </div>
                  
                <br/>
                  <div class="form-group row" >
                  <!-- Client Requestor Name -->
                  <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Client Requestor Name:</label>
                      <div style="background-color: white; width:32%;padding-top: 1%;">
                        <select id="clientRequestorEmail" name="client_requestor_email" class="form-control" required style="background-color:white;width:100%;">
                        <option value="">-- Select --</option>
                        </select>
                      </div>
                      
                    </div>
                    </div>
                  
                    <br/>
                    <!-- Client Requestor Email -->
                    <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Client Email (selected):</label>
                      <input type="email" id="clientRequestorEmailDisplay" class="form-control" readonly>
                    </div>
                  </div>
                 <br/>
                
                  <div class="form-group row" >
                      <!-- Value -->
                  <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Value(£):</label>
                      <input type="number" name="value" class="form-control" required>
                    </div>
                  </div>
                  
                <br/>
                  <div class="form-group row" >
                      <!-- Completed By Name -->
                  <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Form Completed By Name:</label>
                      <input type="text" name="completed_by_name" class="form-control" value="<%= userName%>" required readonly disabled>
                    </div>
                  
                    <!-- Completed By Email -->
                    <div class="form-group d-flex align-items-center">
                      <label class="mb-0 mr-2" style="min-width: 200px;">Form Completed By Email:</label>
                      <input type="email" name="completed_by_email" class="form-control inputHubspot" value="<%= userEmail %>" required readonly disabled>
                    </div>
                  </div>
                  
                <br/>
                <input type="hidden" name="submission_timestamp" id="submissionTimestamp">

                  <div class="text-center">
                    <button type="submit" class="btn btn-primary">Submit</button>
                  </div>
                </form>
              
        </div>
      </div>
    </div>
  </div> 

</section>

<script>
  // Tutor email map
  const tutorEmails = {
    <% tutors.forEach((tutor, index) => { %>
      "<%= tutor.first_name %> <%= tutor.last_name %>": "<%= tutor.email %>"<%= index < tutors.length - 1 ? ',' : '' %>
    <% }) %>
  };

  // Auto-fill tutor email
  document.getElementById('tutorName').addEventListener('change', function () {
    document.getElementById('tutorEmail').value = tutorEmails[this.value] || '';
  });
</script>

<script>
  let nextAfter = null;
  const select = document.getElementById('subClientSelect');

  async function loadCompanies(after = null) {
    const res = await fetch(`/hubspot/companies${after ? `?after=${after}` : ''}`);
    const { companies, nextAfter: next } = await res.json();

    companies.forEach(company => {
      const option = document.createElement('option');
      option.value = company.id;
      option.textContent = company.name;
      select.appendChild(option);
    });

    nextAfter = next;

    // Add or update Load More option
    const existing = document.getElementById('loadMoreOption');
    if (nextAfter) {
      if (!existing) {
        const more = document.createElement('option');
        more.id = 'loadMoreOption';
        more.disabled = true;
        more.textContent = '⏳ Scroll to load more...';
        select.appendChild(more);
      }
    } else if (existing) {
      existing.remove(); // No more to load
    }
  }

  // Load first batch on page load
  loadCompanies();

  // Load more on scroll to bottom
  select.addEventListener('scroll', function () {
    const { scrollTop, scrollHeight, clientHeight } = select;
    if (scrollTop + clientHeight >= scrollHeight - 5 && nextAfter) {
      loadCompanies(nextAfter);
    }
  });
</script>

<script>
  $('#subClientSelect').select2({
    theme: 'bootstrap4',
    placeholder: 'Click to search company...',
    minimumInputLength: 2,
    ajax: {
      url: '/hubspot/companies/search',
      delay: 300,
      data: function (params) {
        return {
          q: params.term // search term
        };
      },
      processResults: function (data) {
        return {
          results: data.map(company => ({
            id: company.id,
            text: company.name
          }))
        };
      }
    }
  });
</script>

<script>
  $(document).ready(function () {
    $('#clientRequestorEmail').select2({
      theme: 'bootstrap4',
      placeholder: 'Search for a client...',
      minimumInputLength: 2,
      ajax: {
        url: '/hubspot/contacts/search',
        delay: 300,
        data: function (params) {
          return { q: params.term };
        },
        processResults: function (data) {
          return {
            results: data.map(contact => ({
              id: contact.email, // submitted value
              text: `${contact.first_name} ${contact.last_name}`
            }))
          };
        }
      },
      //width: '100%'
    });

    // Show selected email in display input
    $('#clientRequestorEmail').on('select2:select', function (e) {
      const selectedEmail = e.params.data.id;
      document.getElementById('clientRequestorEmailDisplay').value = selectedEmail;
    });
  });
</script>

<script>
  // Auto-fill client requestor email
  document.addEventListener('DOMContentLoaded', function () {
    const requestorSelect = document.getElementById('clientRequestor');
    const emailDisplay = document.getElementById('clientRequestorEmailDisplay');

    if (requestorSelect && emailDisplay) {
      requestorSelect.addEventListener('change', function () {
        emailDisplay.value = clientEmails[this.value] || '';
      });
    }
  });
</script>


<script>
  // Set submission date/time in ISO format (e.g., 2024-03-27T15:42:00Z)
  document.getElementById('submissionTimestamp').value = new Date().toISOString();
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>






<%- include('../../partials/footer') %>
